{% extends "base.html" %}

{% block title %}Dashboard - My Diary{% endblock %}

{% block extra_head %}
<style>
/* Premium Dashboard Styles */
.dashboard-header {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-secondary));
    color: white;
    padding: 2rem 0;
    margin-bottom: 1rem;
    border-radius: 0 0 30px 30px;
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.stats-card {
    border: none;
    border-radius: 20px;
    background: linear-gradient(145deg, var(--card-bg), var(--card-bg-dark, #f8f9fa));
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--bs-primary), var(--bs-secondary), var(--bs-success));
}

.stats-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
}

.stats-card .card-title {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.streak-card {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
}

.streak-card .card-title {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.analytics-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    background: rgba(var(--card-bg-rgb, 255, 255, 255), 0.95);
    backdrop-filter: blur(10px);
}

.analytics-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
}

.heatmap-card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
}

.entry-card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
    padding: 20px;
}

.entry-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--bs-primary), var(--bs-secondary));
}

.entry-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
}

.entry-title {
    font-weight: 700;
    color: var(--bs-body-color);
    margin-bottom: 0.5rem;
}

.count-up {
    animation: countUp 1s ease-out;
}

@keyframes countUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-slide-up {
    opacity: 0;
    transform: translateY(30px);
    animation: slideUp 0.6s ease forwards;
}

.animate-delay-1 { animation-delay: 0.1s; }
.animate-delay-2 { animation-delay: 0.2s; }
.animate-delay-3 { animation-delay: 0.3s; }
.animate-delay-4 { animation-delay: 0.4s; }

@keyframes slideUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.is-loading {
    position: relative;
    overflow: hidden;
}

.is-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Enhanced search form */
.search-form .card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    background: linear-gradient(145deg, var(--card-bg), var(--card-bg-dark, #f8f9fa));
}

.search-form .card-header {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-secondary));
    color: white;
    border-radius: 20px 20px 0 0;
    border: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 1.5rem 0;
        margin-bottom: 0.5rem;
    }
    
    .stats-card .card-title {
        font-size: 2rem;
    }
}

/* Consistent dashboard spacing */
.dashboard-section {
    padding: 2rem 0;
}

.dashboard-section:first-child {
    padding-top: 1rem;
}

.dashboard-section:last-child {
    padding-bottom: 3rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>

<script id="analytics-data" type="application/json" nonce="{{ csp_nonce() }}">
{{ analytics|tojson|safe }}
</script>

<script nonce="{{ csp_nonce() }}">
// Advanced Search JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Save search functionality
    window.saveSearch = function() {
        const searchParams = new URLSearchParams(window.location.search);
        const searchData = {
            query: searchParams.get('search'),
            type: searchParams.get('search_type'),
            mood: searchParams.get('mood'),
            tag: searchParams.get('tag'),
            dateFrom: searchParams.get('date_from'),
            dateTo: searchParams.get('date_to'),
            wordsMin: searchParams.get('words_min'),
            wordsMax: searchParams.get('words_max'),
            sort: searchParams.get('sort'),
            savedAt: new Date().toISOString()
        };
        
        // Get existing saved searches
        let savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        
        // Check if this search already exists
        const exists = savedSearches.some(search => 
            JSON.stringify(search) === JSON.stringify(searchData)
        );
        
        if (!exists) {
            savedSearches.push(searchData);
            // Keep only last 10 searches
            if (savedSearches.length > 10) {
                savedSearches = savedSearches.slice(-10);
            }
            localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
            
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="bi bi-check-circle"></i> Search saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.search-form').prepend(alert);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        } else {
            // Show info message
            const alert = document.createElement('div');
            alert.className = 'alert alert-info alert-dismissible fade show';
            alert.innerHTML = `
                <i class="bi bi-info-circle"></i> This search is already saved.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.search-form').prepend(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    };
    
    // Load saved searches dropdown
    function loadSavedSearches() {
        const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        if (savedSearches.length === 0) return;
        
        // Create dropdown menu for saved searches
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-menu';
        dropdown.innerHTML = `
            <h6 class="dropdown-header">Saved Searches</h6>
            <hr class="dropdown-divider">
        `;
        
        savedSearches.forEach((search, index) => {
            const item = document.createElement('a');
            item.className = 'dropdown-item';
            item.href = '#';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${search.query || 'All Entries'}</span>
                    <small class="text-muted">${new Date(search.savedAt).toLocaleDateString()}</small>
                </div>
                ${search.mood || search.tag ? `<small class="text-muted">Filters: ${[search.mood, search.tag].filter(Boolean).join(', ')}</small>` : ''}
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                applySavedSearch(search);
            });
            
            dropdown.appendChild(item);
        });
        
        // Add clear all option
        if (savedSearches.length > 0) {
            const clearAll = document.createElement('a');
            clearAll.className = 'dropdown-item text-danger';
            clearAll.href = '#';
            clearAll.innerHTML = '<i class="bi bi-trash"></i> Clear All';
            clearAll.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('savedSearches');
                location.reload();
            });
            dropdown.appendChild(clearAll);
        }
        
        // Add dropdown button to search form
        const searchForm = document.querySelector('.search-form .card-header');
        if (searchForm && !searchForm.querySelector('.saved-searches-dropdown')) {
            const dropdownDiv = document.createElement('div');
            dropdownDiv.className = 'dropdown saved-searches-dropdown ms-2';
            dropdownDiv.innerHTML = `
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-bookmark"></i> Saved
                </button>
            `;
            dropdownDiv.appendChild(dropdown);
            searchForm.appendChild(dropdownDiv);
        }
    }
    
    // Apply saved search
    function applySavedSearch(search) {
        const params = new URLSearchParams();
        
        if (search.query) params.set('search', search.query);
        if (search.type) params.set('search_type', search.type);
        if (search.mood) params.set('mood', search.mood);
        if (search.tag) params.set('tag', search.tag);
        if (search.dateFrom) params.set('date_from', search.dateFrom);
        if (search.dateTo) params.set('date_to', search.dateTo);
        if (search.wordsMin) params.set('words_min', search.wordsMin);
        if (search.wordsMax) params.set('words_max', search.wordsMax);
        if (search.sort) params.set('sort', search.sort);
        
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }
    
    // Initialize saved searches
    loadSavedSearches();
    
    // Add event listener for save search button
    const saveSearchBtn = document.getElementById('saveSearchBtn');
    if (saveSearchBtn) {
        saveSearchBtn.addEventListener('click', saveSearch);
    }
    
    // Add event listeners for delete forms
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this entry?\n\nThis action cannot be undone.')) {
                e.preventDefault();
            } else {
                // Add loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
                submitBtn.disabled = true;
            }
        });
    });
    
    // Auto-expand filters if any are applied
    const hasFilters = window.location.search.includes('mood=') || 
                      window.location.search.includes('tag=') || 
                      window.location.search.includes('date_from') ||
                      window.location.search.includes('words_min') ||
                      window.location.search.includes('sort=');
                      
    if (hasFilters) {
        const collapse = document.getElementById('advancedSearchFilters');
        if (collapse) {
            const bsCollapse = new bootstrap.Collapse(collapse, { show: true });
        }
    }
});
</script>
{% endblock %}


{% block content %}
<style>
    /* Premium dashboard enhancements */
    .stats-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--bs-primary), var(--bs-secondary), var(--bs-success));
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .stats-card:hover::before {
        opacity: 1;
    }

    .stats-card .card-title {
        font-weight: 800;
        font-size: 3rem;
        background: linear-gradient(135deg, var(--bs-primary), var(--bs-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .stats-card .card-text {
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.875rem;
    }

    /* Analytics cards */
    .analytics-card {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(24px);
        transition: all 0.3s ease;
        position: relative;
    }

    .analytics-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
    }

    /* Mood heatmap */
    .mood-heatmap {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        padding: 1rem;
    }

    .mood-day {
        aspect-ratio: 1;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .mood-day:hover {
        transform: scale(1.2);
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .mood-day[data-mood="happy"] { background: linear-gradient(135deg, #28a745, #20c997); }
    .mood-day[data-mood="sad"] { background: linear-gradient(135deg, #6c757d, #495057); }
    .mood-day[data-mood="excited"] { background: linear-gradient(135deg, #ffc107, #fd7e14); }
    .mood-day[data-mood="anxious"] { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    .mood-day[data-mood="neutral"] { background: linear-gradient(135deg, #17a2b8, #20c997); }

    /* Progress rings */
    .progress-ring {
        transform: rotate(-90deg);
        transition: stroke-dashoffset 0.5s ease;
    }

    .progress-ring-circle {
        stroke-linecap: round;
        stroke-dasharray: 314.159;
        stroke-dashoffset: 314.159;
        transition: stroke-dashoffset 1s ease;
    }

    /* Dashboard header */
</style>
<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="h2 fw-bold mb-2 animate-slide-up animate-delay-1">
                    Welcome back, {{ current_user.username.split()[0] if current_user.username else 'Diary Writer' }}! üåü
                </h1>
                <p class="mb-0 animate-slide-up animate-delay-2">
                    Your personal journey continues. Track your thoughts, emotions, and growth.
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-flex gap-2 justify-content-lg-end animate-slide-up animate-delay-3">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="newEntryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-plus-circle-fill me-2"></i> Write New Entry
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="newEntryDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('main.new_entry') }}">
                                <i class="bi bi-pencil-fill me-2"></i> Blank Entry
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='gratitude_journal') }}">
                                <i class="bi bi-heart-fill text-danger me-2"></i> Gratitude Journal
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='daily_reflection') }}">
                                <i class="bi bi-lightbulb-fill text-warning me-2"></i> Daily Reflection
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='goal_setting') }}">
                        <i class="bi bi-bullseye"></i> Goal Setting
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='mood_check_in') }}">
                        <i class="bi bi-emoji-smile"></i> Mood Check-in
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='creative_writing') }}">
                        <i class="bi bi-brush"></i> Creative Writing
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='learning_growth') }}">
                        <i class="bi bi-book"></i> Learning & Growth
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='dream_journal') }}">
                        <i class="bi bi-moon-stars"></i> Dream Journal
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry', template='quick_notes') }}">
                        <i class="bi bi-lightning"></i> Quick Notes
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.new_entry') }}#template-section">
                        <i class="bi bi-grid"></i> Browse All Templates
                    </a></li>
                </ul>
            </div>
            <a href="{{ url_for('main.calendar_view') }}" class="btn btn-outline-info">
                <i class="bi bi-calendar"></i> Calendar View
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-download"></i> Export
                    {% if search_query or mood_filter or tag_filter %}
                        <span class="badge bg-primary ms-1">{{ entries.total }}</span>
                    {% endif %}
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('main.export_entries_json', search=search_query, mood=mood_filter, tag=tag_filter) }}">
                        <i class="bi bi-filetype-json"></i> Export as JSON
                        {% if search_query or mood_filter or tag_filter %}
                            <small class="text-muted d-block">({{ entries.total }} filtered entries)</small>
                        {% endif %}
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('main.export_entries_markdown', search=search_query, mood=mood_filter, tag=tag_filter) }}">
                        <i class="bi bi-markdown"></i> Export as Markdown
                        {% if search_query or mood_filter or tag_filter %}
                            <small class="text-muted d-block">({{ entries.total }} filtered entries)</small>
                        {% endif %}
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Advanced Search Form -->
    <div class="search-form">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-search me-2"></i>Search Entries
                </h6>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSearchFilters">
                    <i class="bi bi-funnel"></i> Filters
                </button>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.dashboard') }}">
                    <div class="row g-3">
                        <!-- Main Search -->
                        <div class="col-md-8">
                            <div class="input-group search-input-group">
                                <input type="text" class="form-control" name="search"
                                       placeholder="Search your entries..." value="{{ search_query or '' }}">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                        <!-- Search Type -->
                        <div class="col-md-4">
                            <select class="form-select" name="search_type">
                                <option value="all" {{ 'selected' if request.args.get('search_type') == 'all' or not request.args.get('search_type') }}>All Fields</option>
                                <option value="title" {{ 'selected' if request.args.get('search_type') == 'title' }}>Title Only</option>
                                <option value="content" {{ 'selected' if request.args.get('search_type') == 'content' }}>Content Only</option>
                                <option value="semantic" {{ 'selected' if request.args.get('search_type') == 'semantic' }}>Semantic Search</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="collapse mt-3" id="advancedSearchFilters">
                        <div class="row g-3">
                            <!-- Date Range -->
                            <div class="col-md-6">
                                <label for="date_from" class="form-label">Date Range</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="date_from" 
                                               value="{{ request.args.get('date_from') or '' }}" 
                                               placeholder="From">
                                    </div>
                                    <div class="col-6">
                                        <input type="date" class="form-control" name="date_to" 
                                               value="{{ request.args.get('date_to') or '' }}" 
                                               placeholder="To">
                                    </div>
                                </div>
                            </div>
                            <!-- Mood Filter -->
                            <div class="col-md-6">
                                <label for="mood" class="form-label">Mood</label>
                                <select class="form-select" name="mood">
                                    <option value="">All Moods</option>
                                    <option value="üòä Happy" {{ 'selected' if request.args.get('mood') == 'üòä Happy' }}>üòä Happy</option>
                                    <option value="üò¢ Sad" {{ 'selected' if request.args.get('mood') == 'üò¢ Sad' }}>üò¢ Sad</option>
                                    <option value="üò° Angry" {{ 'selected' if request.args.get('mood') == 'üò° Angry' }}>üò° Angry</option>
                                    <option value="üò¥ Tired" {{ 'selected' if request.args.get('mood') == 'üò¥ Tired' }}>üò¥ Tired</option>
                                    <option value="üòÉ Excited" {{ 'selected' if request.args.get('mood') == 'üòÉ Excited' }}>üòÉ Excited</option>
                                    <option value="üòå Peaceful" {{ 'selected' if request.args.get('mood') == 'üòå Peaceful' }}>üòå Peaceful</option>
                                    <option value="üòï Confused" {{ 'selected' if request.args.get('mood') == 'üòï Confused' }}>üòï Confused</option>
                                    <option value="üòç Grateful" {{ 'selected' if request.args.get('mood') == 'üòç Grateful' }}>üòç Grateful</option>
                                </select>
                            </div>
                            <!-- Tags Filter -->
                            <div class="col-md-6">
                                <label for="tag" class="form-label">Tags</label>
                                <select class="form-select" name="tag">
                                    <option value="">All Tags</option>
                                    {% for tag in available_tags %}
                                    <option value="{{ tag.name }}" {{ 'selected' if request.args.get('tag') == tag.name }}>
                                        {{ tag.name }} ({{ tag.entries|length }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Word Count Range -->
                            <div class="col-md-6">
                                <label for="words_min" class="form-label">Word Count</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control" name="words_min" 
                                               value="{{ request.args.get('words_min') or '' }}" 
                                               placeholder="Min">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control" name="words_max" 
                                               value="{{ request.args.get('words_max') or '' }}" 
                                               placeholder="Max">
                                    </div>
                                </div>
                            </div>
                            <!-- Sort Options -->
                            <div class="col-md-6">
                                <label for="sort_by" class="form-label">Sort By</label>
                                <select class="form-select" name="sort">
                                    <option value="date_desc" {{ 'selected' if request.args.get('sort') == 'date_desc' or not request.args.get('sort') }}>Newest First</option>
                                    <option value="date_asc" {{ 'selected' if request.args.get('sort') == 'date_asc' }}>Oldest First</option>
                                    <option value="title_asc" {{ 'selected' if request.args.get('sort') == 'title_asc' }}>Title A-Z</option>
                                    <option value="title_desc" {{ 'selected' if request.args.get('sort') == 'title_desc' }}>Title Z-A</option>
                                    <option value="words_desc" {{ 'selected' if request.args.get('sort') == 'words_desc' }}>Most Words</option>
                                    <option value="words_asc" {{ 'selected' if request.args.get('sort') == 'words_asc' }}>Fewest Words</option>
                                </select>
                            </div>
                            <!-- Action Buttons -->
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Apply Filters
                                    </button>
                                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-clockwise"></i> Reset
                                    </a>
                                    {% if search_query or request.args.get('mood') or request.args.get('tag') or request.args.get('date_from') %}
                                        <button type="button" class="btn btn-outline-danger" id="saveSearchBtn">
                                            <i class="bi bi-bookmark"></i> Save Search
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Search Results Summary -->
    {% if search_query or mood_filter or tag_filter or date_from or date_to or words_min or words_max or sort_by != 'date_desc' %}
    <div class="search-results-summary">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-2">Search Results</h6>
                <p class="mb-0">
                    Found <strong>{{ entries.total }}</strong> entry{{ 'ies' if entries.total != 1 else '' }}
                    {% if search_query %} matching "<em>{{ search_query }}</em>"{% endif %}
                </p>
                <div class="mt-2">
                    {% if search_type and search_type != 'all' %}
                        <span class="filter-badge">
                            {{ search_type.title() }} Search
                        </span>
                    {% endif %}
                    {% if mood_filter %}
                        <span class="filter-badge">
                            Mood: {{ mood_filter }}
                        </span>
                    {% endif %}
                    {% if tag_filter %}
                        <span class="filter-badge">
                            Tag: {{ tag_filter }}
                        </span>
                    {% endif %}
                    {% if date_from or date_to %}
                        <span class="filter-badge">
                            Date: {{ date_from or 'any' }} - {{ date_to or 'any' }}
                        </span>
                    {% endif %}
                    {% if words_min or words_max %}
                        <span class="filter-badge">
                            Words: {{ words_min or '0' }}-{{ words_max or '‚àû' }}
                        </span>
                    {% endif %}
                    {% if sort_by != 'date_desc' %}
                        <span class="filter-badge">
                            Sort: {{ sort_by.replace('_', ' ').title() }}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x"></i> Clear All
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {% if search_query and not entries.items %}
        <div class="mb-3">
            <p class="text-muted">
                {% if entries.items %}
                    Found {{ entries.total }} entries matching "{{ search_query }}"
                    {% if mood_filter %}
                        with mood "{{ mood_filter }}"
                    {% endif %}
                {% else %}
                    No entries found matching "{{ search_query }}"
                    {% if mood_filter %}
                        with mood "{{ mood_filter }}"
                    {% endif %}
                {% endif %}
            </p>
        </div>
    {% endif %}

    {% if onboarding_tasks %}
    <div class="card border-0 shadow-sm mb-4 onboarding-card animate-slide-up animate-delay-1">
        <div class="card-header d-flex justify-content-between align-items-center bg-white">
            <div>
                <h5 class="mb-0">Getting started checklist</h5>
                <small class="text-muted">Complete the steps below to unlock the full experience.</small>
            </div>
            <span class="badge bg-primary">
                {{ onboarding_tasks.completed|length }}/{{ onboarding_tasks.total }} done
            </span>
        </div>
        <div class="card-body">
            {% if onboarding_tasks.pending %}
                <div class="row g-3">
                    {% for task in onboarding_tasks.pending %}
                    <div class="col-md-6 animate-slide-up animate-delay-{{ loop.index }}">
                        <div class="border rounded p-3 h-100 d-flex flex-column">
                            <div class="d-flex align-items-start justify-content-between mb-2">
                                <div>
                                    <strong>{{ task.label }}</strong>
                                    <p class="text-muted small mb-0">{{ task.help }}</p>
                                </div>
                            </div>
                            <div class="mt-auto">
                                <a href="{{ task.cta_url }}" class="btn btn-sm btn-outline-primary">
                                    {{ task.cta_label }}
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-success mb-0 animate-fade-in" role="alert">
                    <i class="bi bi-check-circle-fill"></i> Nicely done! You‚Äôve completed all onboarding steps.
                </div>
            {% endif %}

            {% if onboarding_tasks.completed %}
                <details class="mt-3">
                    <summary class="text-muted small">See completed steps</summary>
                    <ul class="list-unstyled mt-2 mb-0">
                        {% for task in onboarding_tasks.completed %}
                        <li class="d-flex align-items-center text-success small mb-1">
                            <i class="bi bi-check2-circle me-2"></i> {{ task.label }}
                        </li>
                        {% endfor %}
                    </ul>
                </details>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if current_user.is_authenticated and current_user.allow_ads and config.ADSENSE_CLIENT_ID and config.ADSENSE_SLOT_ID
          and stats.total_entries > 0 and entries.items %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <small class="text-muted d-block mb-2">Sponsored</small>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="{{ config.ADSENSE_CLIENT_ID }}"
                         data-ad-slot="{{ config.ADSENSE_SLOT_ID }}"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Enhanced Dashboard Analytics -->
    {% if not search_query %}
    <div class="row mb-4">
        <div class="col-lg-9">
            <!-- Core Stats -->
            <div class="row g-3 mb-4 stats-grid" data-animate="stagger">
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center h-100 shadow-sm">
                        <div class="card-body">
                            <div class="stats-icon text-primary"><i class="bi bi-journal-text"></i></div>
                            <h3 class="card-title count-up" data-target="{{ stats.total_entries }}">0</h3>
                            <p class="card-text text-muted">Total Entries</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center h-100 shadow-sm">
                        <div class="card-body">
                            <div class="stats-icon text-success"><i class="bi bi-calendar-plus"></i></div>
                            <h3 class="card-title count-up" data-target="{{ stats.entries_this_month }}">0</h3>
                            <p class="card-text text-muted">This Month</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center h-100 shadow-sm">
                        <div class="card-body">
                            <div class="stats-icon text-warning"><i class="bi bi-clock-history"></i></div>
                            <h3 class="card-title count-up" data-target="{{ stats.recent_entries }}">0</h3>
                            <p class="card-text text-muted">Past 7 Days</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stats-card text-center h-100 shadow-sm streak-card">
                        <div class="card-body">
                            <div class="stats-icon text-purple"><i class="bi bi-fire"></i></div>
                            <h3 class="card-title count-up" data-target="{{ stats.streak_count }}">0</h3>
                            <p class="card-text text-muted mb-1">Current Streak</p>
                            <small class="text-muted">Best: {{ stats.best_streak }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Section -->
            <div class="row g-3 mb-4">
                <!-- Mood Trends -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm analytics-card">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-emoji-smile text-primary me-2"></i>
                                Mood Trends
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if analytics.mood_chart.labels %}
                            <div class="mood-chart-container">
                                <canvas id="moodChart" width="400" height="200"></canvas>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-primary">Most Common</span>
                                    <span class="fw-bold">{{ analytics.stats.most_common_mood or 'N/A' }}</span>
                                </div>
                                <div class="mood-insights">
                                    {% for mood, count in analytics.mood_chart.labels|zip(analytics.mood_chart.data) %}
                                    <div class="insight-item">
                                        <span class="insight-label">{{ mood }}</span>
                                        <span class="insight-value">{{ count }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-emoji-neutral fs-1 mb-3 d-block"></i>
                                <p>No mood data available yet</p>
                                <small>Start adding moods to your entries to see trends!</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Writing Activity Heatmap -->
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm analytics-card">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar-week text-success me-2"></i>
                                Writing Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="activityHeatmap" class="heatmap-container"></div>
                            <div class="mt-3 productivity-grid">
                                <div class="productivity-stats">
                                    <div class="insight-item">
                                        <span class="insight-label">Avg. Words/Entry</span>
                                        <span class="insight-value">{{ "%.0f"|format(analytics.productivity.avg_words_per_entry or 0) }}</span>
                                    </div>
                                    <div class="insight-item">
                                        <span class="insight-label">Peak Writing Day</span>
                                        <span class="insight-value">{{ analytics.productivity.peak_day or 'N/A' }}</span>
                                    </div>
                                </div>
                                <div class="consistency-panel">
                                    <div class="consistency-ring" style="--consistency-color: var(--bs-success); --consistency-track: rgba(25, 135, 84, 0.1);">
                                        <div class="consistency-center">
                                            <div class="consistency-value">{{ "%.0f"|format(analytics.productivity.consistency_score or 0) }}%</div>
                                            <div class="consistency-label">Consistency</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keywords & Topics -->
            <div class="row g-3 mb-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm analytics-card">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-tags text-warning me-2"></i>
                                Popular Topics & Keywords
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if analytics.keywords.top_topics %}
                            <div class="keyword-cloud" id="keywordCloud"></div>
                            <div class="mt-3">
                                <h6 class="text-muted mb-3">Top Keywords</h6>
                                <div class="row g-2">
                                    {% for keyword in analytics.keywords.top_topics[:8] %}
                                    {% set size_class = ['keyword-size-xs', 'keyword-size-sm', 'keyword-size-md', 'keyword-size-lg', 'keyword-size-xl'][(keyword.count / analytics.keywords.top_topics[0].count * 4)|round|int] %}
                                    <div class="col-auto">
                                        <span class="badge rounded-pill bg-light text-dark border keyword-badge {{ size_class }}">
                                            {{ keyword.word }} ({{ keyword.count }})
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-search fs-1 mb-3 d-block"></i>
                                <p>No keywords identified yet</p>
                                <small>Write more entries to discover your writing patterns!</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Writing Trends -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm analytics-card" style="height: 280px;">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-graph-up text-info me-2"></i>
                                Writing Trends
                            </h5>
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div style="height: 120px; position: relative;">
                                <canvas id="trendChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                            <div class="mt-2">
                                <div class="insight-item d-flex justify-content-between">
                                    <span class="insight-label small">This Week</span>
                                    <span class="insight-value text-success small">+{{ analytics.trend.weekly_change or 0 }}%</span>
                                </div>
                                <div class="insight-item d-flex justify-content-between">
                                    <span class="insight-label small">This Month</span>
                                    <span class="insight-value text-info small">{{ analytics.trend.monthly_total or 0 }} entries</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            {% if current_user.is_authenticated and current_user.allow_ads and config.ADSENSE_CLIENT_ID %}
            <div class="card sticky-top" style="top: 1rem;">
                <div class="card-body p-2">
                    <small class="text-muted d-block mb-2 text-center">Advertisement</small>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="{{ config.ADSENSE_CLIENT_ID }}"
                         data-ad-slot="sidebar-skyscraper"
                         data-ad-format="vertical"
                         data-full-width-responsive="true"></ins>
                    <script nonce="{{ csp_nonce() }}">
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if stats.most_common_mood %}
    <div class="alert alert-light border d-flex align-items-center gap-3 mb-4 animate-fade-in" role="alert">
        <div class="alert-icon"><i class="bi bi-emoji-smile text-warning"></i></div>
        <div>
            <strong>Top mood lately:</strong> {{ stats.most_common_mood }}
            {% if stats.last_entry_at %}
                <div class="small text-muted">Last written {{ stats.last_entry_at.strftime('%B %d, %Y') }}</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if not search_query and stats.total_entries > 0 %}
    <div class="row g-3 mb-4 analytics-row">
        <div class="col-12 col-xl-6">
            <div class="card analytics-card heatmap-card is-loading" data-analytics="heatmap">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Mood Heatmap</h5>
                        <small class="text-muted">Last 90 days</small>
                    </div>
                    <span class="badge bg-light text-dark">Daily count</span>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-heatmap"></div>
                    <div class="heatmap-grid" aria-hidden="true"></div>
                    <div class="heatmap-legend mt-3 d-flex justify-content-between text-muted small">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-6">
            <div class="card analytics-card is-loading" data-analytics="trend">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Mood Trend</h5>
                        <small class="text-muted">Last 30 days</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-chart"></div>
                    <canvas id="moodTrendChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 analytics-row">
        <div class="col-12 col-lg-6">
            <div class="card analytics-card is-loading" data-analytics="mood-breakdown">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Mood Breakdown</h5>
                        <small class="text-muted">All time</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-chart"></div>
                    <canvas id="moodChart" height="240"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card analytics-card is-loading" data-analytics="keywords">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Themes Spotlight</h5>
                        <small class="text-muted">Top {{ analytics.keywords['items']|length }} from last 30 days</small>
                    </div>
                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ analytics.keywords.source|title }}</span>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-pill-list"></div>
                    <div class="keyword-pills d-flex flex-wrap gap-2" data-keywords-target>
                        {% for item in analytics.keywords['items'] %}
                        <button class="btn btn-sm btn-outline-primary keyword-pill" data-keyword="{{ item.label }}">
                            <span>{{ item.label }}</span>
                            <span class="badge bg-primary bg-opacity-25 text-primary">{{ item.count }}</span>
                        </button>
                        {% endfor %}
                        {% if analytics.keywords['items']|length == 0 %}
                        <p class="text-muted mb-0">Not enough recent data yet ‚Äî keep writing!</p>
                        {% endif %}
                    </div>
                    <small class="text-muted d-block mt-2">Tap a chip to filter entries by keyword.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 analytics-row">
        <div class="col-12 col-xl-6">
            <div class="card analytics-card is-loading" data-analytics="streaks">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Streak Momentum</h5>
                        <small class="text-muted">Stay on track</small>
                    </div>
                    <span class="badge bg-purple bg-opacity-10 text-purple"><i class="bi bi-fire"></i></span>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-insight"></div>
                    <ul class="insight-list list-unstyled mb-0">
                        <li class="insight-item">
                            <span class="insight-label">Current streak</span>
                            <span class="insight-value"><span class="count-up" data-target="{{ analytics.streaks.current }}">0</span> days</span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-label">Best streak</span>
                            <span class="insight-value"><span class="count-up" data-target="{{ analytics.streaks.best }}">0</span> days</span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-label">Entries this week</span>
                            <span class="insight-value"><span class="count-up" data-target="{{ analytics.streaks.entries_this_week }}">0</span></span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-label">Entries this month</span>
                            <span class="insight-value"><span class="count-up" data-target="{{ analytics.streaks.entries_this_month }}">0</span></span>
                        </li>
                        {% if stats.last_entry_at %}
                        <li class="insight-item">
                            <span class="insight-label">Last entry</span>
                            <span class="insight-value text-muted">{{ stats.last_entry_at.strftime('%b %d, %Y') }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-6">
            <div class="card analytics-card is-loading" data-analytics="productivity">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Productivity Pulse</h5>
                        <small class="text-muted">Last 30 days</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <a href="{{ url_for('main.productivity_dashboard') }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-graph-up"></i> Full Dashboard
                        </a>
                        <span class="badge bg-primary bg-opacity-10 text-primary"><i class="bi bi-activity"></i></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="skeleton skeleton-insight"></div>
                    <div class="productivity-grid">
                        <div class="consistency-panel">
                            <div class="consistency-ring" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ analytics.productivity.consistency_percent }}" data-consistency-ring="{{ analytics.productivity.consistency_percent }}">
                                <div class="consistency-center">
                                    <span class="consistency-label text-muted">Consistency</span>
                                    <span class="consistency-value"><span class="count-up" data-target="{{ analytics.productivity.consistency_percent }}">0</span>%</span>
                                </div>
                            </div>
                            <p class="text-muted small mb-0">Active days: <strong><span class="count-up" data-target="{{ analytics.productivity.active_days_30 }}">0</span></strong> / {{ analytics.productivity.last_30_days }}</p>
                        </div>
                        <div class="productivity-stats">
                            <div class="insight-item">
                                <span class="insight-label">Entries written</span>
                                <span class="insight-value"><span class="count-up" data-target="{{ analytics.productivity.entries_last_30 }}">0</span></span>
                            </div>
                            <div class="insight-item">
                                <span class="insight-label">Avg. per active day</span>
                                <span class="insight-value"><span class="count-up" data-target="{{ '%.1f'|format(analytics.productivity.avg_entries_per_active_day) }}" data-decimals="1">0.0</span></span>
                            </div>
                            <div class="insight-item">
                                <span class="insight-label">Avg. per day</span>
                                <span class="insight-value"><span class="count-up" data-target="{{ '%.1f'|format(analytics.productivity.avg_entries_per_day) }}" data-decimals="1">0.0</span></span>
                            </div>
                            <div class="insight-item">
                                <span class="insight-label">Current streak pace</span>
                                <span class="insight-value text-muted">{{ analytics.streaks.current }} days active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Mood Filter Buttons -->
    {% if not search_query and stats.total_entries > 0 %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center flex-wrap gap-3 mb-3">
                <div>
                    <h6 class="card-title mb-0">Filter by Mood:</h6>
                </div>
                <div class="btn-group mood-filter-buttons" role="group">
                    <a href="{{ url_for('main.dashboard', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-primary' if not mood_filter else 'btn-outline-primary' }}">
                        All
                    </a>
                    <a href="{{ url_for('main.dashboard', mood='üòä Happy', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-success' if mood_filter == 'üòä Happy' else 'btn-outline-success' }}">
                        üòä Happy
                    </a>
                    <a href="{{ url_for('main.dashboard', mood='üò¢ Sad', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-info' if mood_filter == 'üò¢ Sad' else 'btn-outline-info' }}">
                        üò¢ Sad
                    </a>
                    <a href="{{ url_for('main.dashboard', mood='üò° Angry', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-warning' if mood_filter == 'üò° Angry' else 'btn-outline-warning' }}">
                        üò° Angry
                    </a>
                    <a href="{{ url_for('main.dashboard', mood='üò¥ Tired', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-secondary' if mood_filter == 'üò¥ Tired' else 'btn-outline-secondary' }}">
                        üò¥ Tired
                    </a>
                    <a href="{{ url_for('main.dashboard', mood='üòÉ Excited', search=search_query, tag=tag_filter) }}"
                       class="btn btn-sm {{ 'btn-danger' if mood_filter == 'üòÉ Excited' else 'btn-outline-danger' }}">
                        üòÉ Excited
                    </a>
                </div>
                {% if mood_filter %}
                    <a href="{{ url_for('main.dashboard', search=search_query, tag=tag_filter) }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-x"></i> Clear Filter
                    </a>
                {% endif %}
            </div>
            {% if available_tags %}
            <div class="d-flex align-items-center flex-wrap gap-2">
                <h6 class="card-title mb-0">Tags:</h6>
                <a class="badge rounded-pill {{ 'bg-primary text-white' if not tag_filter else 'bg-light text-dark border' }}"
                   href="{{ url_for('main.dashboard', search=search_query, mood=mood_filter) }}">
                    All
                </a>
                {% for tag in available_tags %}
                    <a class="badge rounded-pill {{ 'bg-primary text-white' if tag.slug == tag_filter else 'bg-light text-dark border' }}"
                       href="{{ url_for('main.dashboard', tag=tag.slug, search=search_query, mood=mood_filter) }}">
                        <i class="bi bi-tag"></i> {{ tag.name }}
                    </a>
                {% endfor %}
                {% if tag_filter %}
                    <a class="badge rounded-pill bg-danger text-white" href="{{ url_for('main.dashboard', search=search_query, mood=mood_filter) }}">
                        <i class="bi bi-x"></i> Clear Tag
                    </a>
                {% endif %}
            </div>
            {% endif %}
            {% if mood_filter %}
                <p class="text-muted mb-0">
                    Showing entries with mood: <strong>{{ mood_filter }}</strong>
                    {% if entries.items %}
                        ({{ entries.total }} found)
                    {% endif %}
                </p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if entries %}
        <div class="entries-grid">
            {% for entry in entries %}
                <div class="card entry-card">
                    <div class="card-body">
                        <div class="entry-header">
                            <h5 class="card-title entry-title">{{ entry.title or 'Untitled' }}</h5>
                            <div class="entry-date">{{ entry.created_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            {% if entry.mood %}
                                <div class="mood-badge">{{ entry.mood }}</div>
                            {% endif %}
                        </div>
                        <div class="entry-preview">
                            <div class="entry-content-preview" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                {{ (entry.content[:300] + ('...' if entry.content|length > 300 else '')) | markdown_to_html | safe }}
                            </div>
                            {% if entry.tags %}
                                <div class="mt-3 d-flex flex-wrap gap-2">
                                    {% for tag in entry.tags %}
                                        <a href="{{ url_for('main.dashboard', tag=tag.slug) }}" class="badge rounded-pill bg-light text-dark border">
                                            <i class="bi bi-tag"></i> {{ tag.name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="entry-actions">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}" class="btn btn-secondary btn-sm">View</a>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('main.export_entry_json', entry_id=entry.id) }}">
                                            <i class="bi bi-filetype-json"></i> Export as JSON
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <form method="POST" action="{{ url_for('main.delete_entry', entry_id=entry.id) }}" style="display: inline;" class="delete-form" onsubmit="return confirmDeleteEntry(event)">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% if current_user.is_authenticated and current_user.allow_ads and config.ADSENSE_CLIENT_ID and (loop.index % 3 == 0) and not loop.last %}
                <div class="card border-0 shadow-sm entry-ad-card">
                    <div class="card-body text-center p-3">
                        <small class="text-muted d-block mb-2">Advertisement</small>
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="{{ config.ADSENSE_CLIENT_ID }}"
                             data-ad-slot="in-feed-ads"
                             data-ad-format="fluid"
                             data-full-width-responsive="true"></ins>
                        <script nonce="{{ csp_nonce() }}">
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if entries.pages > 1 %}
        <nav aria-label="Entries pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if entries.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.dashboard', page=entries.prev_num, search=search_query, mood=mood_filter, tag=tag_filter) }}">Previous</a>
                    </li>
                {% endif %}

                {% for page_num in entries.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if page_num == entries.page else '' }}">
                            <a class="page-link" href="{{ url_for('main.dashboard', page=page_num, search=search_query, mood=mood_filter, tag=tag_filter) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                {% if entries.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.dashboard', page=entries.next_num, search=search_query, mood=mood_filter, tag=tag_filter) }}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <div class="card no-entries">
            <div class="card-body text-center">
                {% if search_query %}
                    <h3>No entries found</h3>
                    <p>Your search for "{{ search_query }}" didn't return any results.</p>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">Show All Entries</a>
                {% elif mood_filter %}
                    <h3>No entries found</h3>
                    <p>No entries found with mood "{{ mood_filter }}".</p>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">Show All Entries</a>
                {% else %}
                    <h3>No entries yet</h3>
                    <p>Start writing your first diary entry!</p>
                    <a href="{{ url_for('main.new_entry') }}" class="btn btn-primary">Write Your First Entry</a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
