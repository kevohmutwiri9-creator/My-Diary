{% extends 'base.html' %}
{% block title %}Advanced Analytics - My Diary{% endblock %}
{% block content %}
  <div class="card fade-in">
    <div class="card-header">
      <h1 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Advanced Analytics</h1>
    </div>
    <div class="card-body">
      {% if analytics.total_entries > 0 %}
        <!-- Key Metrics Row -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card border-primary">
              <div class="card-body text-center">
                <h5 class="card-title text-primary">Total Entries</h5>
                <div class="display-4 mb-2">{{ analytics.total_entries }}</div>
                <p class="text-muted">All time</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card border-info">
              <div class="card-body text-center">
                <h5 class="card-title text-info">Total Words</h5>
                <div class="display-4 mb-2">{{ "{:,}".format(analytics.total_words) }}</div>
                <p class="text-muted">All entries</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card border-success">
              <div class="card-body text-center">
                <h5 class="card-title text-success">Avg Words/Entry</h5>
                <div class="display-4 mb-2">{{ "%.0f"|format(analytics.avg_words_per_entry) }}</div>
                <p class="text-muted">Per entry</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card border-warning">
              <div class="card-body text-center">
                <h5 class="card-title text-warning">Writing Streak</h5>
                <div class="display-4 mb-2">{{ analytics.writing_streak }}</div>
                <p class="text-muted">Days in a row</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Category Distribution</h5>
              </div>
              <div class="card-body">
                <canvas id="categoryChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-emoji-smile"></i> Mood Distribution</h5>
              </div>
              <div class="card-body">
                <canvas id="moodChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Writing Patterns Row -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Monthly Writing</h5>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Writing Time Patterns</h5>
              </div>
              <div class="card-body">
                <canvas id="timeChart" width="400" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Insights Row -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Most Productive Day</h5>
              </div>
              <div class="card-body text-center">
                <div class="display-5 mb-2 text-primary">{{ analytics.most_productive_day or 'N/A' }}</div>
                <p class="text-muted">Day of week</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Top Tags</h5>
              </div>
              <div class="card-body">
                {% if analytics.tag_frequency %}
                  {% for tag, count in analytics.tag_frequency.items() %}
                    <span class="badge bg-primary me-2 mb-2">{{ tag }} ({{ count }})</span>
                  {% endfor %}
                {% else %}
                  <p class="text-muted">No tags used yet</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Entries -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Entries</h5>
          </div>
          <div class="card-body">
            {% if entries %}
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Title</th>
                      <th>Words</th>
                      <th>Mood</th>
                      <th>Category</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for entry in entries %}
                      <tr>
                        <td>{{ entry.created_at.strftime('%b %d, %Y') }}</td>
                        <td>{{ entry.title[:50] }}{% if entry.title|length > 50 %}...{% endif %}</td>
                        <td>{{ entry.body.split()|length }}</td>
                        <td>
                          {% if entry.mood %}
                            <span class="badge bg-info">{{ entry.mood }}</span>
                          {% else %}
                            <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if entry.category %}
                            <span class="badge bg-secondary">{{ entry.category }}</span>
                          {% else %}
                            <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No entries yet</p>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-graph-up-arrow display-1 text-muted"></i>
          <h3 class="mt-3">No analytics data available yet</h3>
          <p class="text-muted">Start writing entries to see your advanced analytics!</p>
          <a href="{{ url_for('main.new_entry') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Write First Entry
          </a>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Hidden data for JavaScript -->
  <script type="application/json" id="analyticsData">
  {{ analytics|tojson|safe }}
  </script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Hidden data for JavaScript
  const analyticsDataElement = document.getElementById('analyticsData');
  let analyticsData = {};
  
  if (analyticsDataElement) {
    analyticsData = JSON.parse(analyticsDataElement.textContent);
  }
  
  // Category Distribution Chart
  const categoryCtx = document.getElementById('categoryChart');
  if (categoryCtx && analyticsData.category_distribution) {
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(analyticsData.category_distribution),
        datasets: [{
          data: Object.values(analyticsData.category_distribution),
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  // Mood Distribution Chart
  const moodCtx = document.getElementById('moodChart');
  if (moodCtx && analyticsData.mood_distribution) {
    new Chart(moodCtx, {
      type: 'pie',
      data: {
        labels: Object.keys(analyticsData.mood_distribution),
        datasets: [{
          data: Object.values(analyticsData.mood_distribution),
          backgroundColor: [
            '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#e83e8c'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  // Monthly Writing Chart
  const monthlyCtx = document.getElementById('monthlyChart');
  if (monthlyCtx && analyticsData.monthly_writing) {
    new Chart(monthlyCtx, {
      type: 'line',
      data: {
        labels: Object.keys(analyticsData.monthly_writing).sort(),
        datasets: [{
          label: 'Entries per Month',
          data: Object.keys(analyticsData.monthly_writing).sort().map(function(month) {
            return analyticsData.monthly_writing[month];
          }),
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
  
  // Writing Time Patterns Chart
  const timeCtx = document.getElementById('timeChart');
  if (timeCtx && analyticsData.writing_times) {
    new Chart(timeCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(analyticsData.writing_times),
        datasets: [{
          label: 'Entries by Time Period',
          data: Object.values(analyticsData.writing_times),
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
</script>
{% endblock %}
